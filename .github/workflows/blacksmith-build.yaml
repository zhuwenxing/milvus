name: Blacksmith Build

# This workflow uses Blacksmith bare-metal runners for faster C++ compilation.
# Requires Blacksmith GitHub App installed on the repository.
# Supports C++ build output hash cache to skip rebuild when unchanged.

on:
  push:
    paths:
      - 'scripts/**'
      - 'internal/**'
      - 'client/**'
      - 'pkg/**'
      - 'cmd/**'
      - 'build/**'
      - 'tests/integration/**'
      - '.github/workflows/blacksmith-build.yaml'
      - '.env'
      - docker-compose.yml
      - Makefile
      - go.mod
      - '!**.md'
      - '!build/ci/jenkins/**'
  pull_request:
    paths:
      - 'scripts/**'
      - 'internal/**'
      - 'pkg/**'
      - 'client/**'
      - 'cmd/**'
      - 'build/**'
      - 'tests/integration/**'
      - '.github/workflows/blacksmith-build.yaml'
      - '.env'
      - docker-compose.yml
      - Makefile
      - go.mod
      - '!**.md'
      - '!build/ci/jenkins/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  Build:
    name: Build and Push Image on Blacksmith (16 vCPU)
    runs-on: blacksmith-16vcpu-ubuntu-2204
    timeout-minutes: 90
    permissions:
      contents: read
      packages: write
    steps:
      - name: 'Setup $HOME'
        run: |
            if [ -z "$HOME" ]; then
                echo '$HOME was no set'
                echo "HOME=/home/zilliz-user" >> $GITHUB_ENV
            fi
            echo "HOME variable is:$HOME"
            echo "GITHUB_ENV variable is:$GITHUB_ENV"
      - name: Setup mold
        uses: rui314/setup-mold@v1
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: 'Check Changed files'
        id: changed-files-cpp
        uses: tj-actions/changed-files@v46
        with:
          since_last_remote_commit: 'true'
          files: |
            **/*.cpp
            **/*.cc
            **/*.c
            **/*.h
            **/*.hpp
            **/*.CMakeLists.txt
            **/conanfile.*
      - name: 'Setup Use USE_ASAN'
        if: steps.changed-files-cpp.outputs.any_changed == 'true'
        run: |
          echo "useasan=OFF" >> $GITHUB_ENV
          echo "Setup USE_ASAN to true since cpp file(s) changed"
      - name: Mount ccache (Sticky Disk)
        uses: useblacksmith/stickydisk@v1
        with:
          key: milvus-ccache
          path: .docker/amd64-ubuntu22.04-ccache
      - name: Mount conan (Sticky Disk)
        uses: useblacksmith/stickydisk@v1
        with:
          key: milvus-conan
          path: .docker/amd64-ubuntu22.04-conan
      - name: Mount go-mod (Sticky Disk)
        uses: useblacksmith/stickydisk@v1
        with:
          key: milvus-go-mod
          path: .docker/amd64-ubuntu22.04-go-mod
      - name: Prepare .docker directories
        run: |
          sudo chown -R $(id -u):$(id -g) .docker
          mkdir -p .docker/amd64-ubuntu22.04-go-mod
          mkdir -p .docker/amd64-ubuntu22.04-vscode-extensions
      - name: Compute C++ source hash
        id: cpp-hash
        run: |
          HASH=$(git ls-tree -r HEAD internal/core/ cmake/ scripts/core_build.sh | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          CACHE_DIR=".docker/amd64-ubuntu22.04-ccache"
          if [ -f "$CACHE_DIR/cpp-output.hash" ] && \
             [ "$(cat $CACHE_DIR/cpp-output.hash)" = "$HASH" ] && \
             [ -f "$CACHE_DIR/cpp-output.tar.zst" ]; then
            echo "cache_hit=true" >> $GITHUB_OUTPUT
            echo "::notice::C++ build cache HIT ($HASH)"
          else
            echo "cache_hit=false" >> $GITHUB_OUTPUT
            echo "::notice::C++ build cache MISS ($HASH)"
          fi
      - name: Build
        run: |
          CACHE_DIR=".docker/amd64-ubuntu22.04-ccache"
          if [ "${{ steps.cpp-hash.outputs.cache_hit }}" = "true" ] && tar --zstd -xf "$CACHE_DIR/cpp-output.tar.zst"; then
            echo "C++ cache hit, building Go only"
            ./build/builder.sh /bin/bash -c 'make build-go && LIBRARY_PATH=$(pwd)/lib GOPATH=$GOPATH bash scripts/install_milvus.sh'
          else
            echo "C++ cache miss, full build"
            ./build/builder.sh /bin/bash -c "make install USE_ASAN=${{env.useasan}} && chmod -R a+rwx /home/milvus/.conan"
          fi
      - name: Save C++ build cache
        if: steps.cpp-hash.outputs.cache_hit != 'true'
        run: |
          sudo chmod -R a+r internal/core/output/ 2>/dev/null || true
          tar --zstd -cf .docker/amd64-ubuntu22.04-ccache/cpp-output.tar.zst internal/core/output/
          echo "${{ steps.cpp-hash.outputs.hash }}" > .docker/amd64-ubuntu22.04-ccache/cpp-output.hash
          echo "Saved C++ build cache ($(du -sh .docker/amd64-ubuntu22.04-ccache/cpp-output.tar.zst | cut -f1))"
      - name: Strip binaries
        run: |
          sudo chmod -R a+rw bin/ lib/
          strip bin/milvus || true
          find lib/ -name "*.so*" -exec strip --strip-unneeded {} \; 2>/dev/null || true
          ls -lh bin/milvus
          du -sh lib/
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build/docker/milvus/ubuntu22.04/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            TARGETARCH=amd64
