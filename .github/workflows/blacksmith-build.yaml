name: Blacksmith Build

# This workflow uses Blacksmith bare-metal runners for faster C++ compilation.
# Requires Blacksmith GitHub App installed on the repository.
# Supports C++ build output hash cache to skip rebuild when unchanged.
# ARM64 cache warmup complete - testing cache hit performance.

on:
  push:
    paths:
      - 'scripts/**'
      - 'internal/**'
      - 'client/**'
      - 'pkg/**'
      - 'cmd/**'
      - 'build/**'
      - 'tests/integration/**'
      - '.github/workflows/blacksmith-build.yaml'
      - '.env'
      - docker-compose.yml
      - Makefile
      - go.mod
      - '!**.md'
      - '!build/ci/jenkins/**'
  pull_request:
    paths:
      - 'scripts/**'
      - 'internal/**'
      - 'pkg/**'
      - 'client/**'
      - 'cmd/**'
      - 'build/**'
      - 'tests/integration/**'
      - '.github/workflows/blacksmith-build.yaml'
      - '.env'
      - docker-compose.yml
      - Makefile
      - go.mod
      - '!**.md'
      - '!build/ci/jenkins/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  build:
    name: Build ${{ matrix.arch }}
    strategy:
      matrix:
        arch: [amd64, arm64]
        include:
          - arch: amd64
            runner: blacksmith-16vcpu-ubuntu-2204
            ccache_key: milvus-ccache
            conan_key: milvus-conan
            gomod_key: milvus-go-mod
            cmake_build_key: milvus-cmake-build
          - arch: arm64
            runner: blacksmith-16vcpu-ubuntu-2204-arm
            ccache_key: milvus-ccache-arm64
            conan_key: milvus-conan-arm64
            gomod_key: milvus-go-mod-arm64
            cmake_build_key: milvus-cmake-build-arm64
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90
    permissions:
      contents: read
      packages: write
    env:
      PLATFORM_ARCH: ${{ matrix.arch }}
    steps:
      - name: 'Setup $HOME'
        run: |
            if [ -z "$HOME" ]; then
                echo '$HOME was no set'
                echo "HOME=/home/zilliz-user" >> $GITHUB_ENV
            fi
            echo "HOME variable is:$HOME"
            echo "GITHUB_ENV variable is:$GITHUB_ENV"
      - name: Setup mold
        uses: rui314/setup-mold@v1
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: 'Check Changed files'
        id: changed-files-cpp
        uses: tj-actions/changed-files@v46
        with:
          since_last_remote_commit: 'true'
          files: |
            **/*.cpp
            **/*.cc
            **/*.c
            **/*.h
            **/*.hpp
            **/*.CMakeLists.txt
            **/conanfile.*
      - name: 'Setup Use USE_ASAN'
        if: steps.changed-files-cpp.outputs.any_changed == 'true'
        run: |
          echo "useasan=OFF" >> $GITHUB_ENV
          echo "Setup USE_ASAN to true since cpp file(s) changed"
      - name: Mount ccache (Sticky Disk)
        uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ matrix.ccache_key }}
          path: .docker/${{ matrix.arch }}-ubuntu22.04-ccache
      - name: Mount conan (Sticky Disk)
        uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ matrix.conan_key }}
          path: .docker/${{ matrix.arch }}-ubuntu22.04-conan
      - name: Mount go-mod (Sticky Disk)
        uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ matrix.gomod_key }}
          path: .docker/${{ matrix.arch }}-ubuntu22.04-go-mod
      - name: Mount cmake-build (Sticky Disk)
        uses: useblacksmith/stickydisk@v1
        with:
          key: ${{ matrix.cmake_build_key }}
          path: cmake_build
      - name: Prepare directories
        run: |
          sudo chown -R $(id -u):$(id -g) .docker cmake_build
          chmod -R 777 cmake_build 2>/dev/null || true
          mkdir -p .docker/${{ matrix.arch }}-ubuntu22.04-go-mod
          mkdir -p .docker/${{ matrix.arch }}-ubuntu22.04-vscode-extensions
      - name: Compute C++ source hash
        id: cpp-hash
        run: |
          HASH=$(git ls-tree -r HEAD internal/core/ cmake/ scripts/core_build.sh | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          CACHE_DIR=".docker/${{ matrix.arch }}-ubuntu22.04-ccache"
          if [ -f "$CACHE_DIR/cpp-output.hash" ] && \
             [ "$(cat $CACHE_DIR/cpp-output.hash)" = "$HASH" ] && \
             [ -f "$CACHE_DIR/cpp-output.tar.zst" ]; then
            echo "cache_hit=true" >> $GITHUB_OUTPUT
            echo "::notice::C++ build cache HIT ($HASH)"
          else
            echo "cache_hit=false" >> $GITHUB_OUTPUT
            echo "::notice::C++ build cache MISS ($HASH)"
          fi
      - name: Build
        run: |
          CACHE_DIR=".docker/${{ matrix.arch }}-ubuntu22.04-ccache"
          if [ "${{ steps.cpp-hash.outputs.cache_hit }}" = "true" ] && tar --zstd -xf "$CACHE_DIR/cpp-output.tar.zst"; then
            echo "C++ cache hit, building Go only"
            ./build/builder.sh /bin/bash -c 'make build-go && LIBRARY_PATH=$(pwd)/lib GOPATH=$GOPATH bash scripts/install_milvus.sh'
          else
            echo "C++ cache miss, full build"
            ./build/builder.sh /bin/bash -c "make install USE_ASAN=${{env.useasan}} && chmod -R a+rwx /home/milvus/.conan"
          fi
      - name: Save C++ build cache
        if: steps.cpp-hash.outputs.cache_hit != 'true'
        run: |
          sudo chmod -R a+r internal/core/output/ 2>/dev/null || true
          tar --zstd -cf .docker/${{ matrix.arch }}-ubuntu22.04-ccache/cpp-output.tar.zst internal/core/output/
          echo "${{ steps.cpp-hash.outputs.hash }}" > .docker/${{ matrix.arch }}-ubuntu22.04-ccache/cpp-output.hash
          echo "Saved C++ build cache ($(du -sh .docker/${{ matrix.arch }}-ubuntu22.04-ccache/cpp-output.tar.zst | cut -f1))"
      - name: Strip binaries
        run: |
          sudo chmod -R a+rw bin/ lib/
          strip bin/milvus || true
          find lib/ -name "*.so*" -exec strip --strip-unneeded {} \; 2>/dev/null || true
          ls -lh bin/milvus
          du -sh lib/
      - name: Package deb/rpm
        run: |
          NFPM_ARCH=${{ matrix.arch == 'amd64' && 'x86_64' || 'arm64' }}
          curl -sfL https://github.com/goreleaser/nfpm/releases/download/v2.41.1/nfpm_2.41.1_Linux_${NFPM_ARCH}.tar.gz | tar xz -C /usr/local/bin nfpm

          export VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "0.0.0-$(git rev-parse --short HEAD)")
          export ARCH=${{ matrix.arch }}

          nfpm package -p deb -f build/nfpm/nfpm.yaml -t milvus_${VERSION}_${{ matrix.arch }}.deb
          nfpm package -p rpm -f build/nfpm/nfpm.yaml -t milvus-${VERSION}.${{ matrix.arch == 'amd64' && 'x86_64' || 'aarch64' }}.rpm

          ls -lh milvus*.deb milvus*.rpm
      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.arch }}
          path: |
            milvus*.deb
            milvus*.rpm
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build/docker/milvus/ubuntu22.04/Dockerfile
          push: true
          provenance: false
          tags: ghcr.io/${{ github.repository }}:${{ github.sha }}-${{ matrix.arch }}
          build-args: |
            TARGETARCH=${{ matrix.arch }}

  manifest:
    name: Create multi-arch manifest
    needs: build
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Create and push multi-arch manifest
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          IMAGE=ghcr.io/${{ github.repository }}
          docker buildx imagetools create \
            -t $IMAGE:$SHORT_SHA \
            -t $IMAGE:${{ github.ref_name }} \
            $IMAGE:${{ github.sha }}-amd64 \
            $IMAGE:${{ github.sha }}-arm64

  release:
    name: Create GitHub Release
    needs: [build, manifest]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: packages-*
          merge-multiple: true
      - uses: softprops/action-gh-release@v2
        with:
          files: |
            milvus*.deb
            milvus*.rpm
          generate_release_notes: true
