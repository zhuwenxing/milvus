name: Blacksmith Build

# This workflow uses Blacksmith bare-metal runners for faster C++ compilation.
# Requires Blacksmith GitHub App installed on the repository.

on:
  push:
    paths:
      - 'scripts/**'
      - 'internal/**'
      - 'client/**'
      - 'pkg/**'
      - 'cmd/**'
      - 'build/**'
      - 'tests/integration/**'
      - '.github/workflows/blacksmith-build.yaml'
      - '.env'
      - docker-compose.yml
      - Makefile
      - go.mod
      - '!**.md'
      - '!build/ci/jenkins/**'
  pull_request:
    paths:
      - 'scripts/**'
      - 'internal/**'
      - 'pkg/**'
      - 'client/**'
      - 'cmd/**'
      - 'build/**'
      - 'tests/integration/**'
      - '.github/workflows/blacksmith-build.yaml'
      - '.env'
      - docker-compose.yml
      - Makefile
      - go.mod
      - '!**.md'
      - '!build/ci/jenkins/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  Build:
    name: Build and Push Image on Blacksmith (16 vCPU)
    runs-on: blacksmith-16vcpu-ubuntu-2204
    timeout-minutes: 90
    permissions:
      contents: read
      packages: write
    steps:
      - name: 'Setup $HOME'
        run: |
            if [ -z "$HOME" ]; then
                echo '$HOME was no set'
                echo "HOME=/home/zilliz-user" >> $GITHUB_ENV
            fi
            echo "HOME variable is:$HOME"
            echo "GITHUB_ENV variable is:$GITHUB_ENV"
      - name: Setup mold
        uses: rui314/setup-mold@v1
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: 'Check Changed files'
        id: changed-files-cpp
        uses: tj-actions/changed-files@v46
        with:
          since_last_remote_commit: 'true'
          files: |
            **/*.cpp
            **/*.cc
            **/*.c
            **/*.h
            **/*.hpp
            **/*.CMakeLists.txt
            **/conanfile.*
      - name: 'Setup Use USE_ASAN'
        if: steps.changed-files-cpp.outputs.any_changed == 'true'
        run: |
          echo "useasan=OFF" >> $GITHUB_ENV
          echo "Setup USE_ASAN to true since cpp file(s) changed"
      - name: Mount ccache (Sticky Disk)
        uses: useblacksmith/stickydisk@v1
        with:
          key: milvus-ccache
          path: .docker/amd64-ubuntu22.04-ccache
      - name: Mount conan (Sticky Disk)
        uses: useblacksmith/stickydisk@v1
        with:
          key: milvus-conan
          path: .docker/amd64-ubuntu22.04-conan
      - name: Mount go-mod (Sticky Disk)
        uses: useblacksmith/stickydisk@v1
        with:
          key: milvus-go-mod
          path: .docker/amd64-ubuntu22.04-go-mod
      - name: Prepare .docker directories
        run: |
          sudo chown -R $(id -u):$(id -g) .docker
          mkdir -p .docker/amd64-ubuntu22.04-go-mod
          mkdir -p .docker/amd64-ubuntu22.04-vscode-extensions
      - name: Build
        run: |
          ./build/builder.sh /bin/bash -c "make install USE_ASAN=${{env.useasan}} && chmod -R a+rwx /home/milvus/.conan"
      - name: Strip binaries
        run: |
          sudo chmod -R a+rw bin/ lib/
          strip bin/milvus || true
          find lib/ -name "*.so*" -exec strip --strip-unneeded {} \; 2>/dev/null || true
          ls -lh bin/milvus
          du -sh lib/
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build/docker/milvus/ubuntu22.04/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            TARGETARCH=amd64
